# Harmony区块链的分片路线

## harmony的目标

Harmony视以太坊2.0为最大的竞争对手，目标是打造一个基于分片的区块链，具备完全扩展性、安全性。走的是状态分片路线，状态分片是截止目前所有分片方案中最具挑战性的。这个是很高的目标，首先具备完全的可扩展性，Harmony的分片不仅包括交易确认、网络通信，也包括区块链状态的分片。其次要保证分片的安全性。Harmony的分片基于DRG（分布式随机生成）过程，这让它具有无法被预测、公平、可验证和可扩展的特性。此外，Harmony采用了PoS机制，而不是PoW机制来选择验证者，它对PBFT共识机制有自己的优化。PoS有一定的门槛，既要保证小的权益质押者能够参与网络和赚取收益，也要防止恶意攻击者在单个分片获得掌控权。Harmony通过采用自适应信息扩散算法（Adaptive Information Dispersal Algorithm）实现分片内和跨分片网络的信息传播。Harmony还采用Kademlia路由实现跨分片交易随着分片数量增加呈对数级扩展。有了分片，还必须保持跨分片交易的一致性，Harmony也支持跨分片交易，支持分片之间的直接通信，通过原子锁定机制确保跨分片交易的一致性。

## harmony特色

序号|模块|内容
------|---|---
1  |快速拜占庭容错算法（FBFT共识）|对原有的PBFT做了改进，改为FBFT机制中，它也有领导者和验证者的角色，并不要求所有验证者广播他们的投票，领导者运行一个多重签名的签名过程来收集验证者的投票，这个多签的大小是O(1)，然后广播投票。这意味每个验证者只需接收一个多重签名，将通信的复杂度从O(n^2)减少到O(n)。
2  |随机数生成 |harmony中融合了VRF和VDF两种技术。VRF是可验证随机函数（Verifiable Random Function），VDF是可验证延迟函数（Verifiable Delay Function），提出了一种新的随机生成算法。
3  |节点状态的快速同步|harmony中引入了epoch，周期概念，为了减少签名验证计算所带来费用和时间成本，Harmony的每个周期的首个区块包含额外的哈希指针指向上个周期的首个区块。通过这种方式，新节点在追踪其到创世区块的哈希指针时可以跳过一个周期内的其他区块，由此加快对当前区块链状态的验证。
4  |信标链|Harmony参考以太坊，引入信标链，信标链也是一种分片，不过它是特殊的分片链。除了处理交易之外，信标链还有两件事要做：一是生成随机数；二是接收权益质押的代币。
5  |状态分片|Harmony的状态分片采用于基于账户的数据模型（不同于UTXO数据模型）。每个分片链包含自己的账户状态，已有代币在所有分片中分布。用户账户可以在不同的分片中有多个余额，例如，777个代币在分片A中，277个代币在分片B中。用户可以通过跨分片交易转移其在不同分片中的代币，通过原子锁定机制确保跨分片交易的一致性。（**这个其实在harmony中，跨片交易会用基于最终一致性的操作实现，中间不涉及回滚和锁定，也就是harmony本身并不支持事务属性，他们认为，跨片交易只要在起始分片获得共识通过，就可以保证最终在目标分片可以成功完成，这个可能是基于他们fbft公式算法，2f+1的特性，不易产生分叉**）
6  |中间件|Harmony采用Kademlia作为跨分片信息传递的路由机制，使用Kademlia路由协议可以减少网络通信的复杂度。Harmony网络中的每个节点都维护一个包含来自不同分片的节点路由表。当一个分片A的消息要发送到分片B，分片A的节点首先会查看路由表，然后把信息发给距离最近的分片ID的节点。
7  |合约|在harmony中，用户可以在每个分片上各自实例化一个合约，各个分片上实例化的合约不共享状态，独自为政，正如他们的共识机制是各个分片分开共识，用户想要调用指定某一个分片上的合约，需要通过中间件，将交易发送到指定的分片上执行
8  |性能|据harmony官方给的测试数据，在全球部署的4万个节点，126个分片，所有节点都参与共识，tps可达到11万，出块间隔为8秒，感觉这个数据可能有点水分

**[什么是VDF可验证延迟函数](https://blog.priewienv.me/post/verifiable-delay-function-1/)**

主要应用场景获取随机数：
比如在双色球游戏中，我们可以某一期开始的交易哈希+区块哈希+上一个区块哈希作为随机源，比如一个周期为1个小时的话，那我们就设置延迟时间大于1个小时，这样真正的随机值在
一个小时之后才会被计算出来。除非提前一个小时知道随机因子，或者不可能提前预测，随机结果。目前
[harmony团队实现一个版本的VDF可验证延迟函数](https://github.com/harmony-one/vdf)

**raptor码（喷泉码）**

harmony期望使用raptor来对抗区块链网络中的弹性波动

[harmony团队实现的go版本的纠错码库](https://github.com/harmony-one/go-raptorq)






## 参考链接
[蓝狐笔记--Harmony区块链的分片扩展之路](https://mp.weixin.qq.com/s?__biz=MzAwOTk1NjM0NQ==&mid=2247487043&idx=1&sn=fc2d14e7d4adcf82fae7cacfe529a71e&chksm=9b56f0d5ac2179c375b0e6a862ab6458c24042fdc09bc3bcd963c25e0362cd0d35a44ba63aa9&mpshare=1&scene=1&srcid=0703y4Lc6ylXDUTmmVmIuvVy&key=7393e0b0f5ed79b36c8ab7b2ab777c353af36ee651295c3ef9a089f946215a36d0880cc2c11caff523636180a4ec5265e85931f6bf0c6c6eb4d8cad56a2dfefd4eee9f5320591ffcac511ef82b7cd216&ascene=1&uin=MTM3NTg3NjEyMg%3D%3D&devicetype=Windows+10&version=62060833&lang=zh_CN&pass_ticket=YFznKAudlcVM77Jt2jnYOOO%2BR4DZ2shcjmgoRp7KoC%2FvBzvRt0e2txe%2Fg7Q1S%2FJd)
