# 零知识证明概要

## 1. 当区块链遇到零知识证明

### 1.1 什么是零知识证明
wiki百科上对于零知识证明的描述是这样的：证明者可以向验证方证明他们知道X的值，但是不传达任何信息，除了他们知道X的值这件事。零知识证明的本质是通过简单地揭示它来证明某人拥有某些信息，难点在于证明这种占有而不泄露信息本身。

一个经典的例子：阿里巴巴和四十大盗的故事，阿里巴巴知道一个打开藏有宝藏的山洞的咒语，强盗抓住他，逼他说出咒语。阿里巴巴担心自己说出咒语以后会被强盗杀死，于是他对强盗提出了一个办法：你们离我弓箭能射到的距离，你们举起右手我就念咒语打开石门，你们举起左手我就念咒语关闭石门，这样的话如果我不知道咒语你们也可以直接射箭杀死我。这个方案的结果就是：阿里巴巴不用告诉强盗咒语但是证明了他知道咒语。这就是零知识证明应用的一个经典案例。

零知识证明分为交互式和非交互式，顾名思义，前者需要证明者和验证者多次交互完成证明。后者是只要证明者给出答案，后续就不需要交互，任何人都可以证明结果是否正确，但是为了不让整个过程完全由证明者把控(容易作弊),事先一般会约定一个种子，基于这个种子产生的随机序列来完成证明。


### 1.2 比特币的困境

假如你对比特币有了解的话应该知道，比特币就是一个共有的账本，A转给B一笔钱就是在区块链上写一条记录“A转给B 10块钱”，A的10块钱从哪儿来呢？要求必须是以前某人C在区块链上写一条记录“C转给A 10块钱”。于是比特币的区块链上就是存放了一条一条的账本条目：

C转给A 10块钱
A转给B 10块钱
B转给D 5块钱
B转给E 5块钱
E转给D 5块钱
D转给A 10块钱
……

但是这样会带来一个问题，号称匿名的比特币系统却做不到真的匿名，因为账本是公开的，所以大家都能看到A，B，C，D，E都有多少钱，并且是在什么时间得到的这笔钱的。而所谓的匿名性其实是不存在的。

PS：比特币的匿名性其实是指一般无法把A对应到真正的交易人实体，A只是一个账户标号，而不是类似“小明”这样的实际个人。但是假如小明是A账户的拥有者，而小明最终有可能因为操作账户A兑换了人民币或者购买什么东西，而被发现其实A就是小明。所以这个匿名性并不是真正的匿名性。

### 1.3 零知识证明在区块链中的应用

就目前区块链发展中，零知识证明的应用有基于zkSNARKs的Zcash项目，有应用基于零知识证明的签名算法的Hyperledger Fabric项目，有在项目中使用Schnorr签名算法的。区块链中零知识证明的应用灵活多样，但本质上还是为了在不泄露消息的情况下完整某种证明。本文重点讲述zkSNARKs的应用。

在区块链网络中，有一个可以算作优点也可以算作缺点的地方，那就是区块链网络的透明，不可篡改。任何操作都是由共识产生的，所有节点记录了共识的结果，所以在比特币网络在任何交易都是可追溯的。也就是说A账户向B账户转账，C,D,E,F账户转账，全网都是可见的。对于现在社会而言，虽然区块链世界是通过虚拟地址来标示用户身份，但是结合ip信息，上网信息，获取一个用户的真实信息是可能的。所以zCash结合了zkSNARKs的零知识证明实现了对于交易信息的保护。

### 1.4 zkSNARKs 原理
zkSNARK是zero-knowledge succint non-interactive arguments of knowledge的简称，全称里面每个单词都有特定的含义：Zero knowledge：零知识证明，见前文。Succinctness：证据信息较短，方便验证Non-interactivity：几乎没有交互，证明者基本上只要提供一个字符串义工验证。对于区块链来说，这一点至关重要，意味着可以把该消息放在链上公开验证。Arguments：证明过程是计算完好（computationally soundness）的，证明者无法在合理的时间内造出伪证（破解）。跟计算完好对应的是理论完好（perfect soundness)，密码学里面一般都是要求计算完好。of knowledge：对于一个证明者来说，在不知晓特定证明 (witness) 的前提下，构建一个有效的零知识证据是不可能的。接下来，我们一步一步解释这个zkSNARK到底是怎么实现的。同态隐藏说到zkSNARK，不能不提的一个概念就是同态隐藏，说它是zkSNARK的核心技术一点都不为过。满足下面三个条件的函数E(x），我们称之为加法同态。
1.对于大部分的x，在给定的E(x)通常很难求解出x.
2.不同输入将会得到不同输出 - 因此如果x≠y,，则E(x)≠E(y).
3.如果某人知道了E(x)和E(y),，则他可以生成在算数运算式中的x和y.。比如，他们可以使用E(x)和E(y).来计算E(x+y)。
同理我们可以定义乘法同态甚至是全同态。我们常用的的非对称加密方式RSA和ECC都支持加法同态，计算和证明证明需要比较多的公式运算，有时间另外开一篇文章讲解。跟RSA和ECC一样，注意这里的E(x)计算是在有限域里面进行，这个域下文称为Fp。有了同态隐藏这个利器以后，我们就可以实现一定程度的零知识证明了。A拥有x和y两个秘密的数字，需要向B证明这两个数字的和是7，只需要执行下面三个步骤：
1.A计算E(x)，E(y)，并发送给B
2.因为函数E(x)满足加法同态，B可以通过E(x)，E(y)计算E(x+y)
3.B独立计算E(7)，并验证E(x+y)=E(7)
多项式盲验证利用加法同态的特性，我们可以简单的把零知识证明推广到多项式中。假定A知道一个最高d次的多项式P，而B想要知道对应某个s的E(P(s))





我们希望在验证的过程中，A只知道P，不知道s，B只知道s，不知道P，可以通过下面方式实现：
1.对s的每个指数，B计算E(1)，E(s)，...，E(sd)，并发送给A
2.A知道多项式的所有系数，可以利用同态特性计算P(s)，并回送给B
KCA以及完整的多项式盲验证上一章提供的多项式盲验证方式有一个致命的问题，就是B根本没法验证A是真正利用多项式P(s)去计算结果，也就是说无法证明A真正知道这个多项式P(X)。我们继续完善一下上面的验证。我们先定义一个概念：
α对是指满足b=α * a 的一对值（a，b）.注意这里的乘法其实是椭圆曲线（ECC）上的乘法，椭圆曲线上的运算符合两个特性：一是当α值很大的情况下，很难通过a和b倒推出α，二是加法和乘法满足可交换群的特性，也就是说加法和乘法交换律在椭圆曲线上也是成立的。椭圆曲线的运算很复杂，本文暂不详述，大家只要记住椭圆函数的乘法满足同态隐藏的特性，即可完成下面的证明。我们利用α对的特性，构建一个称为KCA（Knowledge of Coefficient Test and Assumption）的过程
1.B随机选择一个α生成α对（a，b），α自己保存，（a，b）发送给A
2.A选择γ，生成(a′,b′)=(γ⋅a,γ⋅b)，把(a′,b′)回传给B。利用交换律，可以证明(a′,b′)也是一个α对，b′=γ⋅b=γα⋅a=α(γ⋅a)=α⋅a′
3.B校验(a′,b′)，证实是α对，就可以断言A知道γ
这个证明可以推广到多个α对的场景，称为d-KCA
1.B发送一系列的α对给A
2.A使用(a′,b′)=(c1⋅a1+c2⋅a2,c1⋅b1+c2⋅b2)生成新的α对
3.B验证通过，可以断言A知道c数组
这个KCA咋看似乎没有什么用，但正好可以补足了之前多项式盲验证 的缺陷，一个完整的多项式盲验证过程如下
0.因为椭圆曲线的乘法符合同态隐藏的特性，A和B可以共同选择x⋅g作为E(x)
1.B计算g,s⋅g,…,sd⋅g和α⋅g,αs⋅g,…,αsd⋅g并发送给A，实际上过程同上一章的第一步，只是把E(x)替代成乘法，增加了αs相应的多项式结果
2.A计算a=P(s)⋅g，b=αP(s)⋅g并回传
3.a值即为B所需校验的E(P(s))结果，同时KCA保证了a值必然是通过多项式生成
好了，到这里喘口气，回顾一下我们现在到底做到了些什么。通过加法同态，我们可以实现加法隐藏，让B在不知道x和y的情况下，校验x+y的值。进一步，通过多项式盲验证，我们可以在不暴露多项式P(X)的情况下，让B校验任意给定s对应的P(s)。接下来坐好扶稳，我们要从多项式推广到任意计算的盲验证了。任意计算转换到多项式证明直接上例子，假定A需要向B证明他知道c1，c2，c3，使(c1⋅c2)⋅(c1+c3)=7，按照惯例，c1，c2，c3需要对B保密。我们要做的第一步就是把计算“拍平”，通过基本的运算符把原计算画成这样的“计算门电路”。



### 1.5 ZCASH怎么结合零知识证明到区块链
Zerocoin做了一个创新，在交易中花费一定的货币来生成一个零币，每个零币有独特的序列号，同时所有的节点共同维护一个作废列表，所有被花费的零币的序列号记录在其中。交易被验证时使用零知识证明的方法，可以在完全不知道消耗的是哪个币的情况下验证交易是否有效。由于交易中并没有签名和地址等信息，整个交易过程中，矿工也并不知道这个零币的来源，因此也就难以对交易历史进行分析而获取用户身份。

zkSNARKs在Zerocoin中的应用是一个很复杂的过程，包括零知识需要的复杂的数学知识。为了降低理解的难度，本文将在接下来将简述zkSNARKs在Zerocoin中的应用，以便读者能够理解这个过程。

对于一次交易验证过程来说，可以将它拆解成一个个逻辑上的验证步骤，进而拆解成由简单算法构成的算术电路。

通过一系列的变换将需要验证的程序转换成验证多个多项式乘积是相等的，如证明t（x）h（x）= w（x）v（x）。

为了让我们的验证更快一点，验证者会首先随机验证一个S点的结果对于等式是否成立。这样的目的能够让证明过程更加高效。

对需要验证的公式进行同态加密（一种加密函数，对明文进行环上的加法和乘法运算再加密，与加密后对密文进行相应的运算，结果是等价的），这样的话验证者在验证的过程中无法获输入的值。

对于t（x）h（x）= w（x）v（x）等式都乘以一个K值，这个K是保密的。那么验证者就不知道本来的t（x），h（x）,w（x）,v（x）。因此信息得到保护。

除此之外，Zerocoin和Zcash都需要内置一些参数，这个参数的不泄露保证了网络的安全。

### 1.6 零知识证明在chain33中应用的展望




[参考链接1](https://studygolang.com/topics/7582?fr=sidebar)

[参考链接2](https://mp.weixin.qq.com/s?__biz=MzU2MjcxNTEwOQ==&mid=2247483893&idx=1&sn=bf7b54f22a172eb89e5ee806e95249e2&chksm=fc64017fcb138869bda2877cd61a57e56cd485ece08aeb8998da5144ae477d18d55378dfdd36&mpshare=1&scene=1&srcid=1222osWJoSEduFRn0dtRjOIx#rd
)

[参考链接3](https://z.cash/blog/snark-explain)

[参考链接4](https://www.jianshu.com/p/b6a14c472cc1)
